<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Entity Linking REST API</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 32px; line-height: 1.5; }
      h1, h2, h3 { margin-top: 24px; }
      code, pre { font-family: "Courier New", monospace; }
      pre { background: #f7f7f7; padding: 12px; overflow: auto; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
      th { background: #f0f0f0; }
    </style>
  </head>
  <body>
    <h1>Entity Linking REST API</h1>
    <p>
      Standalone HTTP API for LLM-based Entity Linking. The service accepts tabular data,
      links entity mentions per cell, and stores results in MongoDB.
    </p>

    <h2>Authentication</h2>
    <p>
      All endpoints require an API key. Provide it via
      <code>X-API-Key: &lt;key&gt;</code> or <code>Authorization: Bearer &lt;key&gt;</code>.
    </p>

    <h2>Endpoint Overview</h2>
    <ul>
      <li><code>GET /health</code> - liveness check</li>
      <li><code>GET /capabilities</code> - supported modes, limits, defaults</li>
      <li><code>POST /jobs</code> - create a job (inline | uri | upload_id); always returns <code>job_id</code></li>
      <li><code>GET /jobs/{job_id}</code> - job status + progress</li>
      <li><code>GET /jobs/{job_id}/results</code> - cursor-paged cell-level finals (no candidates)</li>
      <li><code>GET /jobs/{job_id}/cells/{row}/{col}/candidates</code> - lazy candidates for one cell</li>
      <li><code>POST /jobs/{job_id}:cancel</code> - cancel a job</li>
    </ul>
    <p>Optional:</p>
    <ul>
      <li><code>POST /uploads</code> - pre-signed upload URL + <code>upload_id</code></li>
      <li><code>GET /jobs/{job_id}/events</code> - SSE progress/events</li>
      <li><code>GET /jobs/{job_id}/results/download</code> - signed URL export</li>
      <li><code>GET /jobs/{job_id}/artifacts</code> - list stored artifacts</li>
    </ul>

    <h2>Stable Identifiers</h2>
    <ul>
      <li><code>job_id</code>: opaque string, globally unique per run.</li>
      <li><code>table_id</code>: optional opaque client-provided identifier.</li>
      <li><code>row</code>: zero-based row index in the submitted table.</li>
      <li><code>col</code>: zero-based column index in the submitted table.</li>
      <li><code>cell_id</code>: stable derived identifier (for example <code>row_id:col</code>).</li>
    </ul>

    <h2>Result Models</h2>
    <h3>Final prediction per cell</h3>
    <ul>
      <li><code>entity_id</code> (string; <code>NIL</code> allowed)</li>
      <li><code>label</code> (optional string)</li>
      <li><code>score</code> (float 0..1)</li>
      <li><code>status</code> (<code>linked</code> | <code>nil</code> | <code>error</code>)</li>
    </ul>
    <h3>Candidates (per-cell endpoint)</h3>
    <ul>
      <li><code>rank</code> (int)</li>
      <li><code>entity_id</code> (string)</li>
      <li><code>label</code> (optional string)</li>
      <li><code>score</code> (float 0..1)</li>
      <li><code>features</code> (optional map)</li>
    </ul>

    <h2>Limits and Errors</h2>
    <p>Limits are exposed via <code>GET /capabilities</code>.</p>
    <ul>
      <li><code>400</code> invalid input</li>
      <li><code>401</code> invalid API key</li>
      <li><code>404</code> job not found</li>
      <li><code>409</code> job not cancellable</li>
      <li><code>413</code> payload too large</li>
      <li><code>422</code> invalid schema or format</li>
      <li><code>429</code> rate limited</li>
      <li><code>503</code> model/retriever unavailable</li>
    </ul>

    <h2>Endpoints with Examples</h2>

    <h3>GET /health</h3>
    <pre><code>{
  "ok": true,
  "status": "healthy",
  "time": "2025-01-15T10:12:03Z"
}</code></pre>

    <h3>GET /capabilities</h3>
    <pre><code>{
  "ok": true,
  "data": {
    "input_modes": ["inline", "uri", "upload_id"],
    "supported_formats": ["text/csv", "application/json"],
    "max_inline_bytes": 1048576,
    "max_rows_inline": 5000,
    "max_top_k": 20,
    "max_link_columns": 50,
    "supports_sse": true,
    "supports_exports": true,
    "default_top_k": 5,
    "default_timeout_seconds": 900
  }
}</code></pre>

    <h3>POST /jobs (inline)</h3>
    <pre><code>{
  "table_id": "my_table_001",
  "input": {
    "mode": "inline",
    "format": "application/json",
    "table": {
      "header": ["Title", "Director", "Year"],
      "rows": [
        {"row_id": "r1", "cells": ["Inception", "Christopher Nolan", "2010"]},
        {"row_id": "r2", "cells": ["Alien", "Ridley Scott", "1979"]}
      ]
    }
  },
  "link_columns": ["Title"],
  "row_range": {"start": 0, "limit": 1000},
  "top_k": 5,
  "execution": "async"
}</code></pre>
    <p>
      Per-request model API keys can be supplied as <code>config.lion.model_api_key</code> or via
      the <code>X-LLM-API-Key</code> header. They are stored ephemerally and not persisted in the
      job record.
    </p>

    <pre><code>{
  "ok": true,
  "job_id": "job_01J2H2A9K9M0",
  "table_id": "my_table_001",
  "status": "queued",
  "created_at": "2025-01-15T10:12:08Z",
  "limits": {
    "top_k": 5
  }
}</code></pre>

    <h3>POST /jobs (uri)</h3>
    <pre><code>{
  "table_id": "big_table_2025_01",
  "input": {
    "mode": "uri",
    "format": "text/csv",
    "uri": "s3://bucket/path/table.csv"
  },
  "link_columns": [0],
  "row_range": {"start": 0, "limit": 2000000},
  "top_k": 10,
  "execution": "async"
}</code></pre>

    <h3>POST /uploads (optional)</h3>
    <pre><code>{
  "content_type": "text/csv",
  "content_length": 52428800
}</code></pre>

    <pre><code>{
  "ok": true,
  "upload_id": "up_01J2H2B5X7FQ",
  "upload_url": "/uploads/up_01J2H2B5X7FQ",
  "expires_at": "2025-01-15T10:27:08Z"
}</code></pre>

    <h3>GET /jobs/{job_id}</h3>
    <pre><code>{
  "ok": true,
  "job_id": "job_01J2H2A9K9M0",
  "table_id": "my_table_001",
  "status": "running",
  "progress": {
    "rows_total": 2000000,
    "rows_processed": 325000,
    "cells_total": 2000000,
    "cells_processed": 325000
  },
  "started_at": "2025-01-15T10:12:12Z",
  "updated_at": "2025-01-15T10:20:43Z"
}</code></pre>

    <h3>GET /jobs/{job_id}/results</h3>
    <pre><code>{
  "ok": true,
  "job_id": "job_01J2H2A9K9M0",
  "cursor": "eyJqIjoiam9iXzAxSjJIMkE5SzlNMCIsInIiOjEwMDAsImMiOjB9",
  "next_cursor": "eyJqIjoiam9iXzAxSjJIMkE5SzlNMCIsInIiOjIwMDAsImMiOjB9",
  "results": [
    {
      "row": 0,
      "col": 0,
      "cell_id": "r1:0",
      "mention": "Inception",
      "final": {
        "entity_id": "Q25188",
        "label": "Inception",
        "score": 0.97,
        "status": "linked"
      }
    }
  ]
}</code></pre>

    <h3>GET /jobs/{job_id}/cells/{row}/{col}/candidates</h3>
    <pre><code>{
  "ok": true,
  "job_id": "job_01J2H2A9K9M0",
  "row": 0,
  "col": 0,
  "cell_id": "r1:0",
  "mention": "Inception",
  "candidates": [
    {"rank": 1, "entity_id": "Q25188", "label": "Inception", "score": 0.97},
    {"rank": 2, "entity_id": "Q3797611", "label": "Inception (soundtrack)", "score": 0.21}
  ]
}</code></pre>

    <h3>POST /jobs/{job_id}:cancel</h3>
    <pre><code>{
  "ok": true,
  "job_id": "job_01J2H2A9K9M0",
  "status": "cancelling"
}</code></pre>

    <h3>GET /jobs/{job_id}/events (optional SSE)</h3>
    <pre><code>event: progress
data: {"job_id":"job_01J2H2A9K9M0","rows_processed":400000,"cells_processed":400000}</code></pre>

    <h3>GET /jobs/{job_id}/results/download (optional)</h3>
    <pre><code>{
  "ok": true,
  "job_id": "job_01J2H2A9K9M0",
  "download_url": "/jobs/job_01J2H2A9K9M0/artifacts/results.csv",
  "expires_at": "2025-01-15T11:12:08Z"
}</code></pre>

    <h3>GET /jobs/{job_id}/artifacts (optional)</h3>
    <pre><code>{
  "ok": true,
  "job_id": "job_01J2H2A9K9M0",
  "artifacts": [
    {"name": "results.csv", "type": "export", "size_bytes": 1048576}
  ]
}</code></pre>

    <h2>MongoDB Storage Guidance (High Level)</h2>
    <h3>Collections</h3>
    <ul>
      <li><code>jobs</code>: job metadata, config, status, timestamps</li>
      <li><code>job_events</code>: progress/events, append-only</li>
      <li><code>cell_predictions</code>: final decisions per cell</li>
      <li><code>cell_candidates</code>: per-cell candidates (or embedded for small jobs)</li>
      <li><code>uploads</code>: upload handles, URIs, expiry</li>
    </ul>
    <h3>Chunking strategy</h3>
    <ul>
      <li>Store predictions in row-based chunks (for example 5k-20k rows per chunk).</li>
      <li>Store candidates separately keyed by <code>(job_id, row, col)</code>.</li>
      <li>Stream writes and batch inserts for massive tables.</li>
    </ul>
    <h3>Index recommendations</h3>
    <ul>
      <li><code>cell_predictions</code>: compound <code>(job_id, row, col)</code></li>
      <li><code>cell_predictions</code>: <code>(job_id, status, score)</code></li>
      <li><code>cell_predictions</code>: <code>(job_id, row)</code></li>
      <li><code>cell_candidates</code>: <code>(job_id, row, col)</code></li>
      <li><code>jobs</code>: <code>(status, updated_at)</code>, <code>(table_id)</code></li>
    </ul>

    <h2>OpenAPI-like Outline</h2>
    <ul>
      <li><code>GET /health</code> - liveness state</li>
      <li><code>GET /capabilities</code> - limits, supported input modes, defaults</li>
      <li><code>POST /jobs</code> - create job; fields: <code>table_id</code>, <code>input</code>, <code>link_columns</code>, <code>row_range</code>, <code>top_k</code>, <code>execution</code></li>
      <li><code>GET /jobs/{job_id}</code> - status and progress</li>
      <li><code>GET /jobs/{job_id}/results</code> - cursor-paged final decisions</li>
      <li><code>GET /jobs/{job_id}/cells/{row}/{col}/candidates</code> - candidates per cell</li>
      <li><code>POST /jobs/{job_id}:cancel</code> - cancel job</li>
      <li>Optional: <code>POST /uploads</code>, <code>GET /jobs/{job_id}/events</code>, <code>GET /jobs/{job_id}/results/download</code>, <code>GET /jobs/{job_id}/artifacts</code></li>
    </ul>
  </body>
</html>
